---
- name: Setup SSH Public Key for remote connections
  hosts: all
  become: yes
  vars_files:
    - ../../vars/ssh_key.yml
  vars:
    ssh_user: "{{ ansible_user }}"
    ssh_key_name: "id_rsa"
  
  tasks:
    - name: Ensure .ssh directory exists for user
      ansible.builtin.file:
        path: "/home/{{ ssh_user }}/.ssh"
        state: directory
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: '0700'

    - name: Write public SSH key to remote host
      ansible.builtin.copy:
        content: "{{ ssh_public_key }}"
        dest: "/home/{{ ssh_user }}/.ssh/{{ ssh_key_name }}.pub"
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: '0644'

    - name: Add public key to authorized_keys
      ansible.posix.authorized_key:
        user: "{{ ssh_user }}"
        state: present
        key: "{{ ssh_public_key }}"
        manage_dir: yes

    - name: Set correct permissions for .ssh directory
      ansible.builtin.file:
        path: "/home/{{ ssh_user }}/.ssh"
        state: directory
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: '0700'
        recurse: no

    - name: Verify SSH key permissions
      ansible.builtin.command:
        cmd: "ls -la /home/{{ ssh_user }}/.ssh/"
      register: ssh_permissions
      changed_when: false

    - name: Display SSH directory contents
      ansible.builtin.debug:
        msg: "{{ ssh_permissions.stdout_lines }}"

    - name: Test SSH key (optional)
      ansible.builtin.command:
        cmd: "ssh-keygen -l -f /home/{{ ssh_user }}/.ssh/{{ ssh_key_name }}.pub"
      register: key_fingerprint
      changed_when: false
      ignore_errors: yes

    - name: Display key fingerprint
      ansible.builtin.debug:
        msg: "Fingerprint de la llave: {{ key_fingerprint.stdout }}"
      when: key_fingerprint.rc == 0
