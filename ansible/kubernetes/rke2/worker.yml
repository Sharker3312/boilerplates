- name: Instalación RKE2 Worker desde Cero - RHEL 9
  hosts: workers
  become: yes
  vars:
    rke2_version: "v1.31.8+rke2r1"
    rke2_token: "SecretToken2026!" # Cambiar por ansible-vault en producción
    master_ip: "192.168.1.10" # IP real de tu servidor master

  tasks:
    - name: 1. Preparación del Sistema (Swap y Módulos)
      block:
        - name: Desactivar Swap inmediatamente
          command: swapoff -a
          changed_when: true
          when: ansible_swaptotal_mb > 0

        - name: Eliminar Swap de /etc/fstab
          replace:
            path: /etc/fstab
            regexp: '^([^#].*?\sswap\s+.*)$'
            replace: '# \1'

        - name: Cargar módulos del Kernel necesarios
          copy:
            dest: /etc/modules-load.d/rke2.conf
            content: |
              overlay
              br_netfilter

        - name: Aplicar módulos inmediatamente
          modprobe:
            name: "{{ item }}"
          loop: [overlay, br_netfilter]

    - name: 2. Configuración de Parámetros del Kernel (Sysctl)
      copy:
        dest: /etc/sysctl.d/99-rke2.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
      notify: Reload Sysctl

    - name: 3. Configurar NetworkManager para ignorar interfaces CNI
      copy:
        dest: /etc/NetworkManager/conf.d/rke2-canal.conf
        content: |
          [keyfile]
          unmanaged-devices=interface-name:flannel*;interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:wireguard.cali
      notify: Reload NetworkManager

    - name: 4. Configurar SELinux para RKE2
      block:
        - name: Instalar container-selinux (dependencia RHEL 9)
          dnf:
            name: container-selinux
            state: present

        - name: Instalar paquete rke2-selinux
          dnf:
            name: "https://github.com/rancher/rke2-selinux/releases/download/v0.20.stable.1/rke2-selinux-0.20-1.el9.noarch.rpm"
            state: present
            disable_gpg_check: yes
          when: ansible_distribution_major_version == "9"
          ignore_errors: yes

    - name: 5. Instalar Dependencias y RKE2 Agent
      block:
        - name: Desactivar Firewalld (Evitar conflictos CNI)
          systemd:
            name: firewalld
            state: stopped
            enabled: no
          ignore_errors: yes

        - name: Instalar dependencias necesarias
          dnf:
            name:
              - iptables
              - nfs-utils
              - iscsi-initiator-utils
            state: present

        - name: Descargar e instalar RKE2 Agent via Script Oficial
          shell: |
            curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} INSTALL_RKE2_TYPE="agent" sh -
          args:
            creates: /usr/local/bin/rke2

    - name: 6. Configurar RKE2 Agent
      block:
        - name: Crear directorio de configuración
          file:
            path: /etc/rancher/rke2
            state: directory
            mode: '0750'

        - name: Generar config.yaml para el Agente
          copy:
            dest: /etc/rancher/rke2/config.yaml
            mode: '0640'
            content: |
              server: "https://{{ master_ip }}:9345"
              token: "{{ rke2_token }}"

    - name: 7. Iniciar Servicio RKE2 Agent
      systemd:
        name: rke2-agent
        state: started
        enabled: yes

    - name: 8. Configurar PATH para binarios RKE2
      copy:
        dest: /etc/profile.d/rke2.sh
        mode: '0644'
        content: |
          export PATH=$PATH:/var/lib/rancher/rke2/bin

  handlers:
    - name: Reload Sysctl
      command: sysctl --system
    - name: Reload NetworkManager
      systemd:
        name: NetworkManager
        state: reloaded
